var V=Object.defineProperty;var x=Object.getOwnPropertySymbols;var M=Object.prototype.hasOwnProperty,F=Object.prototype.propertyIsEnumerable;var v=(s,a,c)=>a in s?V(s,a,{enumerable:!0,configurable:!0,writable:!0,value:c}):s[a]=c,P=(s,a)=>{for(var c in a||(a={}))M.call(a,c)&&v(s,c,a[c]);if(x)for(var c of x(a))F.call(a,c)&&v(s,c,a[c]);return s};(function(s,a){typeof exports=="object"&&typeof module!="undefined"?module.exports=a():typeof define=="function"&&define.amd?define(a):(s=typeof globalThis!="undefined"?globalThis:s||self,s.MyLib=a())})(this,function(){"use strict";const s=(e,r,t)=>{let n={size:r.byteLength+3&~3,usage:t,mappedAtCreation:!0},i=e.createBuffer(n);return r[5]=Date.now(),(r instanceof Uint16Array?new Uint16Array(i.getMappedRange()):new Float32Array(i.getMappedRange())).set(r),i.unmap(),i},a=function(e,r){e.addEventListener("mousemove",t=>{let n=t.pageX,i=t.pageY;r.mouseX=n/t.target.clientWidth,r.mouseY=i/t.target.clientHeight})};function c(e=500,r=500){let t=devicePixelRatio;var n=document.createElement("canvas");return n.width=t*e,n.height=t*r,n.style.width=e+"px",document.body.appendChild(n),n}var h={createBuffer:s,createCanvas:c,addMouseEvents:a};async function B(e){let{device:r}=e;if(!e.options.uniforms.texture)return console.log("no texture bound");const t=await createImageBitmap(e.options.uniforms.texture);let n=r.createTexture({size:[t.width,t.height,1],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});return r.queue.copyExternalImageToTexture({source:t},{texture:n},[t.width,t.height]),n}function y(e,r=new Float32Array(16)){let{data:t,device:n}=e;Object.values(t).filter(u=>typeof u!="object");let i=new Float32Array(16);return i.set(r,0),e.uniformsBuffer?(n.queue.writeBuffer(e.uniformsBuffer,0,i.buffer,0,28),e.uniformsBuffer):e.uniformsBuffer=h.createBuffer(n,i,GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST)}function A(e){var f;let{particleBuffers:r,computeVertexBufferData:t,device:n}=e;const i=n.createBindGroup(e.bindGroupDescriptor),u={renderPassDescriptor:e.renderPassDescriptor,texture:e.texture,pipeline:e.pipeline,bindGroup:i,type:"draw"};((f=e==null?void 0:e.compute)==null?void 0:f.numVertices)&&(u.numVertices=e.compute.numVertices()),e.compute&&r&&(u.vertexBuffers=[r[0],t]),e.renderPasses.push(u)}const T=async function(e){let{device:r,renderPassDescriptor:t}=e;t.colorAttachments[0].view=e.context.getCurrentTexture().createView();const n=r.createCommandEncoder();let i=e.renderPasses[0];if(!i)return console.log("no worky");if(e.options.uniforms.modelViewProjectionMatrix){const p=e.options.uniforms.modelViewProjectionMatrix();r.queue.writeBuffer(e.uniformBuffer,0,p.buffer,p.byteOffset,p.byteLength)}let u=new Float32Array(e.options.attributes.position.array.flat());const f=r.createBuffer({size:u.byteLength,usage:GPUBufferUsage.VERTEX,mappedAtCreation:!0});new Float32Array(f.getMappedRange()).set(u),f.unmap();let o=n.beginRenderPass(t);o.setPipeline(i.pipeline),o.setBindGroup(0,i.bindGroup),o.setVertexBuffer(0,f),o.draw(e.options.count,1,0,0),o.end(),r.queue.submit([n.finish()])};async function U(e){let{device:r}=e;const t=new Float32Array(new Array(1e4).fill(5).map((l,d)=>{let w=d/1e3;if(d%2==1)return w%1;if(d%2==0)return w/10})),n=r.createBuffer({size:t.byteLength,usage:GPUBufferUsage.VERTEX,mappedAtCreation:!0});new Float32Array(n.getMappedRange()).set(t),n.unmap(),e.cubeVertices=n;let i={layout:"auto",vertex:{module:r.createShaderModule({code:e.options.vert}),entryPoint:"main",buffers:[{arrayStride:4*10,attributes:[{shaderLocation:0,offset:0,format:"float32x4"},{shaderLocation:1,offset:4*8,format:"float32x2"}]}]},fragment:{module:r.createShaderModule({code:e.options.frag}),entryPoint:"main",targets:[{format:"bgra8unorm"}]},primitive:{topology:"triangle-list",cullMode:"back"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"}};e.compute&&applyCompute(o.vertexBuffers),r.createSampler({magFilter:"linear",minFilter:"linear",mipmapFilter:"nearest"}),y(e);const u=r.createTexture({size:[500*devicePixelRatio,500*devicePixelRatio],format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT}),f={colorAttachments:[{view:void 0,clearValue:{r:.5,g:.5,b:.5,a:1},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:u.createView(),depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}};e.renderPassDescriptor=f;let o=r.createRenderPipeline(P({},i));const p=4*16,m=r.createBuffer({size:p,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});return e.uniformBuffer=m,await B(e),e.bindGroupDescriptor={layout:o.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:m}}]},e.bindGroupDescriptor.entries[0].resource.buffer=y(e),o}async function D(e,r){e.options.shader,e.pipeline=await U(e),A(e)}let E={width:innerWidth,height:innerHeight,pixelRatio:2,time:0,mouseX:0,mouseY:0,angle:0};async function R(e={}){let r=e.canvas||h.createCanvas();const t={renderPassDescriptor:{},options:e,data:Object.assign(E,e.data),compute:e.compute,renderPasses:[]};if(h.addMouseEvents(r,t.data),!navigator.gpu)return console.log("Error: webgpu is not available. Please install canary!!!");const n=r.getContext("webgpu"),i=await navigator.gpu.requestAdapter(),u=await(i==null?void 0:i.requestDevice()),f=navigator.gpu.getPreferredCanvasFormat();Object.assign(t,{device:u,context:n,adapter:i}),n.configure({device:u,format:f,alphaMode:"opaque"});function o(l){return Array.isArray(l)?l.map(d=>o(d)):(y(t,t.options.uniforms.modelViewProjectionMatrix()),T(t),o)}return o.canvas=r,o.prop=b,o.buffer=g,o.initDrawCall=m,o.state=t,o.draw=o,{initDrawCall:m,buffer:g,prop:b,clear:C,frame:p,version:"0.10.0"};function p(l){requestAnimationFrame(function d(){l(),requestAnimationFrame(d)})}async function m(l){return t.options=l,await D(t,t.options),o}}function C(e){state.clearValue.r=e.color[0],state.clearValue.g=e.color[1],state.clearValue.b=e.color[2]}function g(e){if(!(this instanceof g))return new g(e);this.array=e}function b(e){return()=>{let r={viewportWidth:500,viewportHeight:500,tick:Performance.now()};return typeof state.uniforms[e]=="function"?state.uniforms[e](r):state.uniforms[e],state.uniforms[e]}}var G={init:R,version:"0.15.0"};return G});

var N=Object.defineProperty,V=Object.defineProperties;var F=Object.getOwnPropertyDescriptors;var w=Object.getOwnPropertySymbols;var I=Object.prototype.hasOwnProperty,O=Object.prototype.propertyIsEnumerable;var P=(c,o,d)=>o in c?N(c,o,{enumerable:!0,configurable:!0,writable:!0,value:d}):c[o]=d,v=(c,o)=>{for(var d in o||(o={}))I.call(o,d)&&P(c,d,o[d]);if(w)for(var d of w(o))O.call(o,d)&&P(c,d,o[d]);return c},U=(c,o)=>V(c,F(o));(function(c,o){typeof exports=="object"&&typeof module!="undefined"?module.exports=o():typeof define=="function"&&define.amd?define(o):(c=typeof globalThis!="undefined"?globalThis:c||self,c.MyLib=o())})(this,function(){"use strict";const c=(e,r,a)=>{let t={size:r.byteLength+3&~3,usage:a,mappedAtCreation:!0},i=e.createBuffer(t);return r[5]=Date.now(),(r instanceof Uint16Array?new Uint16Array(i.getMappedRange()):new Float32Array(i.getMappedRange())).set(r),i.unmap(),i},o=function(e,r){e.addEventListener("mousemove",a=>{let t=a.pageX,i=a.pageY;r.mouseX=t/a.target.clientWidth,r.mouseY=i/a.target.clientHeight})};function d(e=innerWidth,r=innerHeight){let a=devicePixelRatio;var t=document.createElement("canvas");return t.width=a*e,t.height=a*r,t.style.width=e+"px",document.body.appendChild(t),t}var x={createBuffer:c,createCanvas:d,addMouseEvents:o};let G=async e=>{const r=document.createElement("img"),a=r;return a.width=innerWidth,a.height=innerHeight,r.src=e.data.texture,await r.decode(),await createImageBitmap(r)};async function E(e){var r,a;if(HTMLImageElement===((a=(r=e==null?void 0:e.data)==null?void 0:r.texture)==null?void 0:a.constructor)){let t=e.data.texture;await t.decode(),await createImageBitmap(t),await t.decode();let i=await createImageBitmap(t),n=e.device.createTexture({size:[i.width,i.height,1],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});return e.device.queue.copyExternalImageToTexture({source:i},{texture:n},[i.width,i.height]),e.texture=n,f(e),n}else if(typeof e.data.texture=="string"){let t=e.device.createTexture({size:[900,500,1],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT}),i=await G(e);return e.device.queue.copyExternalImageToTexture({source:i},{texture:t},[i.width,i.height]),e.texture=t,f(e),t}else{let t=e.device.createTexture({size:[256,1,1],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT}),i=new Float32Array(new Array(800).fill(5).map((n,s)=>e.data.texture?e.data.texture[s%e.data.texture.length+n]:Math.random()));return e.texture=t,e.data.music=i,f(e),t}}function f(e){if(!!e.texture&&e.data.texture){let r=new Uint8Array(new Array(1024).fill(5).map((a,t)=>e.data.texture?e.data.texture[t%e.data.texture.length]:Math.random()));e.device.queue.writeTexture({texture:e.texture},r.buffer,{bytesPerRow:3200,rowsPerImage:600},[256,1])}}function y(e){let{data:r,device:a}=e,t=Object.values(r).filter(n=>typeof n!="object"),i=new Float32Array(t.length);return i.set(t,0),e.uniformsBuffer?(a.queue.writeBuffer(e.uniformsBuffer,0,i.buffer,0,4*i.length),e.uniformsBuffer):e.uniformsBuffer=x.createBuffer(a,i,GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST)}function A(e){var s;let{particleBuffers:r,computeVertexBufferData:a,device:t}=e;const i=t.createBindGroup(e.bindGroupDescriptor),n={renderPassDescriptor:e.renderPassDescriptor,texture:e.texture,pipeline:e.pipeline,bindGroup:i,type:"draw"};((s=e==null?void 0:e.compute)==null?void 0:s.numVertices)&&(n.numVertices=e.compute.numVertices()),e.compute&&r&&(n.vertexBuffers=[r[0],a]),e.renderPasses.push(n)}const B=async function(e){let{device:r,renderPassDescriptor:a}=e;a.colorAttachments[0].view=e.context.getCurrentTexture().createView();const t=r.createCommandEncoder();let i=e.renderPasses[0];if(!i)return console.log("no worky");let n=new Float32Array(e.options.attributes.position.array.flat());console.log(n,e.options.attributes.position);const s=r.createBuffer({size:n.byteLength,usage:GPUBufferUsage.VERTEX,mappedAtCreation:!0});new Float32Array(s.getMappedRange()).set(n),s.unmap();let u=t.beginRenderPass(a);u.setPipeline(i.pipeline),u.setBindGroup(0,i.bindGroup),u.setVertexBuffer(0,s),u.draw(3*2,1,0,0),u.end(),r.queue.submit([t.finish()])};async function D(e){let{device:r}=e;const a=new Float32Array(new Array(1e4).fill(5).map((_,b)=>{let T=b/1e3;if(b%2==1)return T%1;if(b%2==0)return T/10})),t=r.createBuffer({size:a.byteLength,usage:GPUBufferUsage.VERTEX,mappedAtCreation:!0});new Float32Array(t.getMappedRange()).set(a),t.unmap(),e.cubeVertices=t;let i={layout:"auto",vertex:{module:r.createShaderModule({code:e.options.vert}),entryPoint:"main",buffers:[{arrayStride:8,attributes:[{shaderLocation:0,offset:0,format:"float32x2"}]}]},fragment:{module:r.createShaderModule({code:e.options.frag}),entryPoint:"main",targets:[{format:"bgra8unorm"}]},primitive:{topology:"triangle-list"}};e.compute&&i.vertex.buffers.push({arrayStride:4*4,stepMode:"instance",attributes:[{shaderLocation:0,offset:0,format:"float32x2"},{shaderLocation:1,offset:2*4,format:"float32x2"}]},{arrayStride:2*4,stepMode:"vertex",attributes:[{shaderLocation:2,offset:0,format:"float32x2"}]});const n=r.createSampler({magFilter:"linear",minFilter:"linear",mipmapFilter:"nearest"}),s=r.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE,buffer:{type:"uniform",minBindingSize:4*7}},{binding:1,visibility:GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE,type:"sampler",sampler:n},{binding:2,visibility:GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE,texture:{}}]}),u=r.createPipelineLayout({bindGroupLayouts:[s]});e.bindGroupLayout=s,y(e);const m={colorAttachments:[{view:void 0,clearValue:{r:.5,g:.5,b:.5,a:1},loadOp:"clear",storeOp:"store"}]};e.renderPassDescriptor=m;let l=r.createRenderPipeline(U(v({},i),{layout:u})),g=await E(e);return e.bindGroupDescriptor={layout:l.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:e.uniformsBuffer}},{binding:1,resource:n},{binding:2,resource:g.createView({baseMipLevel:0,mipLevelCount:1}),texture:{sampleType:"float",viewDimension:"2d",multisampled:0}}]},e.bindGroupDescriptor.entries[0].resource.buffer=y(e),e.bindGroupDescriptor.entries[2].resource=g.createView({baseMipLevel:0,mipLevelCount:1}),l}async function R(e,r){e.options.shader,e.pipeline=await D(e),A(e)}let M={width:innerWidth,height:innerHeight,pixelRatio:2,time:0,mouseX:0,mouseY:0,angle:0};async function C(e={}){let r=e.canvas||x.createCanvas();const a={renderPassDescriptor:{},options:e,data:Object.assign(M,e.data),compute:e.compute,renderPasses:[]};if(x.addMouseEvents(r,a.data),!navigator.gpu)return console.log("Error: webgpu is not available. Please install canary!!!");const t=r.getContext("webgpu"),i=await navigator.gpu.requestAdapter(),n=await(i==null?void 0:i.requestDevice()),s=navigator.gpu.getPreferredCanvasFormat();Object.assign(a,{device:n,context:t,adapter:i}),t.configure({device:n,format:s,alphaMode:"opaque",usage:GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});function u(l){return console.log("am i being drawn?"),Array.isArray(l)?l.map(g=>u(g)):(f(a),y(a),B(a),u)}return u.canvas=r,u.prop=h,u.buffer=p,u.initDrawCall=m,u.state=a,u.draw=u,{initDrawCall:m,buffer:p,prop:h,clear:S};async function m(l){return a.options=l,await R(a,a.options),u}}function S(e){state.clearValue.r=e.color[0],state.clearValue.g=e.color[1],state.clearValue.b=e.color[2]}function p(e){if(!(this instanceof p))return new p(e);this.array=e}function h(e){return()=>state.uniforms.color}var L={init:C};return L});
